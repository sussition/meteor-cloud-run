# Configuration Guide

Complete guide to configuring meteor-cloud-run for your deployment needs.

## Configuration Files

### Main Configuration: `.meteor-cloud-run/config.json`

Generated by `meteor-cloud-run init`, this file contains your deployment configuration:

```json
{
  "projectId": "my-project-12345",
  "region": "us-central1",
  "meteorVersion": "3.2",
  "nodeVersion": "18",
  "settingsFile": "settings.json",
  "cpu": "1",
  "memory": "512Mi",
  "minInstances": 0,
  "maxInstances": 10,
  "concurrency": 80,
  "customDomain": "app.example.com",
  "useLoadBalancer": true,
  "useManagedSSL": true,
  "useStaticIP": true
}
```

**Configuration Options:**

| Option | Type | Description | Default |
|--------|------|-------------|---------|
| `projectId` | string | Google Cloud project ID | Required |
| `region` | string | Google Cloud region | `us-central1` |
| `meteorVersion` | string | Meteor version (auto-detected) | Auto-detected |
| `nodeVersion` | string | Node.js version for container | `18` |
| `settingsFile` | string | Path to settings.json | `settings.json` |
| `cpu` | string | CPU allocation per instance | `1` |
| `memory` | string | Memory allocation per instance | `512Mi` |
| `minInstances` | number | Minimum running instances | `0` |
| `maxInstances` | number | Maximum instances | `10` |
| `concurrency` | number | Requests per instance | `80` |
| `customDomain` | string | Custom domain (optional) | - |
| `useLoadBalancer` | boolean | Use load balancer for custom domain | `false` |
| `useManagedSSL` | boolean | Use Google-managed SSL | `true` |
| `useStaticIP` | boolean | Create static outbound IP | `false` |

### Generated Deployment Files

After `meteor-cloud-run init`, these files are created:

#### `.meteor-cloud-run/Dockerfile`
Multi-stage Docker build configuration that handles the containerization of your Meteor application. Uses the appropriate `geoffreybooth/meteor-base` image based on your detected Meteor version for the build stage, then creates an optimized production image with Node.js.

#### `.meteor-cloud-run/cloudbuild.yaml`
Google Cloud Build configuration that orchestrates the build and deployment process. Handles artifact registry setup, container image building, secret management integration, and Cloud Run service deployment.

#### `.meteor-cloud-run/meteor-cloud-run-startup.sh`
Container startup script that handles dynamic settings loading and application initialization. Manages environment variable setup, settings file processing, and launches the Meteor application with proper configuration.

#### `.meteor-cloud-run/.dockerignore`
Optimizes Docker build performance by excluding unnecessary files and directories from the build context. Prevents local development files, build artifacts, and dependencies from being copied into the container.

## Settings.json Integration

### Format

**Environment Variables for Your App:**
Store all environment variables that your Meteor application needs to run under the `"env"` key within the `"meteor-cloud-run"` namespace. These variables will be available to your application at runtime.

```json
{
  "meteor-cloud-run": {
    "env": {
      "MONGO_URL": "mongodb+srv://user:pass@cluster.mongodb.net/db",
      "ROOT_URL": "https://app.example.com",
      "MAIL_URL": "smtp://user:pass@smtp.gmail.com:587",
      "MONGO_OPLOG_URL": "mongodb+srv://user:pass@cluster.mongodb.net/local",
      "API_KEY": "your-secret-api-key",
      "STRIPE_SECRET": "sk_test_...",
      "JWT_SECRET": "your-jwt-secret",
      "STRIPE_PUBLISHABLE": "pk_test_...",
      "NODE_ENV": "production",
      "HTTP_FORWARDED_COUNT": "1"
    }
  },
  "private": {
    "analyticsSettings": {
      "googleAnalytics": {
        "trackingId": "GA-XXXXX-X"
      }
    }
  },
  "public": {
    "appSettings": {
      "enableFeatureX": true,
      "maxUploadSize": 10485760
    }
  }
}
```

**Key Points:**
- **All environment variables** your app needs should go in `meteor-cloud-run.env`
- **Sensitive variables** (containing passwords, secrets, keys, tokens) are automatically stored in Google Secret Manager
- **Non-sensitive variables** are set as regular environment variables
- **Standard Meteor settings** (`private` and `public`) work as usual and are available via `Meteor.settings`

### Alternative Formats

meteor-cloud-run also supports these formats:

#### Galaxy Format
```json
{
  "galaxy.meteor.com": {
    "env": {
      "MONGO_URL": "mongodb+srv://...",
      "ROOT_URL": "https://app.example.com"
    }
  }
}
```

#### Standard Meteor Format
```json
{
  "env": {
    "MONGO_URL": "mongodb+srv://...",
    "ROOT_URL": "https://app.example.com"
  }
}
```

### Environment Variables Processing

**Secure Variables (stored in Secret Manager):**
- `MONGO_URL`
- `MONGO_OPLOG_URL`
- `MAIL_URL`
- Any variable containing `password`, `secret`, `key`, `token`

**Standard Variables (environment variables):**
- `ROOT_URL`
- `HTTP_FORWARDED_COUNT`
- `DISABLE_WEBSOCKETS`
- Public configuration variables

## Resource Configuration

### CPU Options
- `"1"` - 1 vCPU
- `"2"` - 2 vCPU
- `"4"` - 4 vCPU

### Memory Options
- `"256Mi"` - 256 MB
- `"512Mi"` - 512 MB
- `"1Gi"` - 1 GB
- `"2Gi"` - 2 GB
- `"4Gi"` - 4 GB

### Scaling Configuration

#### Scale-to-Zero (Cost Optimized)
```json
{
  "minInstances": 0,
  "maxInstances": 10,
  "concurrency": 80
}
```
- Scales to 0 when no traffic
- Cold start delay on first request
- Lowest cost option

#### Always-On (Performance Optimized)
```json
{
  "minInstances": 1,
  "maxInstances": 20,
  "concurrency": 80
}
```
- Always has at least 1 instance running
- No cold start delay
- Higher baseline cost

#### High-Traffic Configuration
```json
{
  "minInstances": 2,
  "maxInstances": 100,
  "concurrency": 1000
}
```
- Multiple instances always running
- High concurrency per instance
- Optimized for high-traffic applications

## Custom Domain Configuration

### Basic Custom Domain
```json
{
  "customDomain": "app.example.com",
  "useLoadBalancer": true,
  "useManagedSSL": true
}
```

### Custom Domain with Static Outbound IP
```json
{
  "customDomain": "app.example.com",
  "useLoadBalancer": true,
  "useManagedSSL": true,
  "useStaticIP": true
}
```

**Static Outbound IP Use Cases:**
- MongoDB Atlas IP whitelisting
- Webhook callbacks requiring IP whitelisting
- Third-party API integrations
- Compliance requirements

## Regional Configuration

### Supported Regions
- `us-central1` (Iowa) - Default
- `us-east1` (South Carolina)
- `us-west1` (Oregon)
- `europe-west1` (Belgium)
- `asia-east1` (Taiwan)
- `australia-southeast1` (Sydney)

### Region Selection Factors
- **Latency**: Choose region closest to your users
- **Data residency**: Compliance requirements
- **MongoDB location**: Co-locate with your database
- **Cost**: Some regions have different pricing

## Migration Configuration

### Domain Mapping Migration
For existing deployments using legacy domain mapping:

```json
{
  "enableLoadBalancerMigration": true,
  "createStaticOutboundIp": true
}
```

## Configuration Validation

### Validate Configuration
```bash
meteor-cloud-run info --verbose
```

### Common Configuration Issues

**Invalid Region:**
```json
{
  "region": "invalid-region"  // ❌ Will fail
}
```

**Invalid Resource Limits:**
```json
{
  "memory": "512G",  // ❌ Too high
  "cpu": "100"       // ❌ Invalid option
}
```

**Missing Required Fields:**
```json
{
  // ❌ Missing projectId
  "region": "us-central1"
}
```

## Environment-Specific Configuration

### Multiple Settings Files
```bash
# Development
meteor-cloud-run deploy --settings settings-dev.json

# Staging
meteor-cloud-run deploy --settings settings-staging.json

# Production
meteor-cloud-run deploy --settings settings-prod.json
```

### Configuration Inheritance
Base configuration in `config.json`, environment-specific settings in settings files:

**config.json:**
```json
{
  "projectId": "my-project",
  "region": "us-central1",
  "cpu": "1",
  "memory": "512Mi"
}
```

**settings-prod.json:**
```json
{
  "meteor-cloud-run": {
    "env": {
      "MONGO_URL": "mongodb+srv://prod-cluster...",
      "ROOT_URL": "https://app.mycompany.com"
    }
  }
}
```

For troubleshooting configuration issues, see the [Troubleshooting Guide](troubleshooting.md).